<html>
<head>
	<title>P2P Documentation</title>
	<style type="text/css">
		td{
			font: 100% monospace;
		}
	</style>
</head>
<body>

<table>
<tr><td width="640">

<b>1.0 Abstract</b>
<blockquote>
The libp2p library provides the means to connect to a global DHT (distributed
hash table) on which to lookup and download files from multiple hosts
concurrently.
</blockquote>

<b>2.0 Protocol</b>
<blockquote>
<p>
Summary:
<br>
The protocol is symmetric with the exception of the key exchange. Any message
can go in either direction. All numbers are encoded in big-endian. The protocol
is entirely binary.
</p>
<p>
VLI (Variable Length Integer):
<br>
VLIs are used to save space. VLIs are used when we know the maximum value the integer
must hold. We know the maximum block number of a file so we can use VLIs
when requesting blocks. VLIs are a minimum of 1 byte and a maximum of 8 bytes.
</p>
<p>
Hash vs Root Hash:
<br>
The hash is a hash of the file size (big-endian) followed by the root hash
(20 byte SHA1 hash). Refer to the hash tree section for documentation on the
root hash.
</p>
</blockquote>

<b>2.1 Key Exchange</b>
<blockquote>
<pre>
Each session starts with a Diffie-Hellman-Merkle key exchange.

Host_A initiates a connection with Host_B.
g   = the generator both sides use that is always equal to 2
s_A = secret exponent of Host_A
s_B = secret exponent of Host_B
p   = prime Host_A generates that both sides use
r_A = result of Host_A, g^s_A % p
r_B = result of Host_B, g^s_B % p
k   = secret key
MiM = Man in the middle.
^   = exponentiation symbol
%   = modulo symbol

The section header indicates who sees what.
+-----------------+   +-----------------+   +-----------------+
|     Host_A      |   |       MiM       |   |      Host_B     |
+-----------------+   +-----------------+   +-----------------+
| k = r_B^s_A % p | = | g^(s_A*s_B) % p | = | r_A^s_B % p = k |
+-----------------+   +-----------------+   +-----------------+
</pre>

<br>

<fieldset>
<pre>
Step 0: Host_A sends p and r_A to Host_B.

+---+---+---+---+---+---+---+---+
|       P       |      r_A      |
+---+---+---+---+---+---+---+---+
  0    ...   15  16    ...   31
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Step 1: Host_B receives what was sent in Step 0. Host_B sends r_B to Host_A.

+---+---+---+---+
|      r_B      |
+---+---+---+---+
  0    ...   15
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Step 2: Host_A receives what was sent in Step 1.
Both sides now have all information needed to calculate the secret key.
</pre>
</fieldset>

<br>

<p>
The secret key is used to seed two KISS (created by George Marsaglia) PRNGs. One
PRNG is for sending and one is for receiving. Note that the KISS PRNG is not
cryptographically secure but this is okay because the goal is obfuscation and
not security. Key exchanges without a PKI (public key infrastructure) are
inherently insecure (vulnerable to man-in-the-middle).
</p>

<pre>
|------------------------------ k ------------------------------|
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|       x       |       y       |       z       |       c       |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15

//KISS
uint32_t x, y, z, c;
uint32 extract()
{
	uint64 t, a = 698769069;
	x = 69069 * x + 12345;
	y ^= (y << 13);
	y ^= (y >> 17);
	y ^= (y << 5);
	t = a * z + c;
	c = (t >> 32);
	return x + y + (z = t);
}
</pre>

<p>
After the PRNG is seeded all bytes sent and received are XOR'd against the
output of the PRNGs. The send PRNG of Host_A remains synchronized to the recv
PRNG of Host_B and vise versa.
</p>
</blockquote>

<b>2.2 Commands</b>
<blockquote>

<fieldset>
<pre>
Name: REQUEST_SLOT
Base10: 0
Description: Request a slot for downloading a hash tree and file.

+---+---+---+---+---+---+---+---+
| C |             H             |
+---+---+---+---+---+---+---+---+
  0   1   2   3      ...     20

C = command, H = hash

Possible Responses:
SLOT_ID
REQUEST_SLOT_FAILED (the server does not have the file)
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: REQUEST_SLOT_FAILED
Base10: 1
Description: Server does not have requested file.
Postcondition: Slot is not opened.

+---+
| C |
+---+
  0

C = command

Possible Responses: None
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: REQUEST_BLOCK_HASH_TREE
Base10: 2
Description: Request a block from a hash tree.

+---+---+---+---+---+---+
| C | S |       B       |
+---+---+---+---+---+---+
  0   1   2    ...    n

C = command, S = slot ID, B = block number (VLI)

Note: B is sized such that it can hold the maximum tree block number.

Possible Responses:
BLOCK
FILE_REMOVED
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: REQUEST_BLOCK_FILE
Base10: 3
Description: Request a block from a file.

+---+---+---+---+---+---+
| C | S |       B       |
+---+---+---+---+---+---+
  0   1   2    ...    n

C = command, S = slot ID, B = block number (VLI)

Possible Responses:
BLOCK
FILE_REMOVED
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: CLOSE_SLOT
Base10: 4
Description: This is done after a hash tree or file is finished downloading.

+---+---+
| C | S |
+---+---+
  0   1

C = command, S = slot number
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: FILE_REMOVED
Base10: 5
Description: Host no longer has the file. When this is received a CLOSE_SLOT
should be sent to close the slot. We don't close the slot after sending
FILE_REMOVED because there could be requests in the pipeline.

+---+
| C |
+---+
  0

C = command
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: SLOT_ID
Base10: 6
Description: Sent in response to REQUEST_SLOT. The slot ID is needed to request
hash tree and file blocks.

+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| C | S | K |             F                 |       R       |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
  0   1   2   3   4   5   6   7   8   9  10  11    ...   30

C = command, S = slot ID, K = status, F = file size, R = root hash

Status:

Base10: 0
Description: Hash tree complete, file complete.

Base10: 1
Description: Hash tree complete, file incomplete.

Base10: 2
Description: Hash tree incomplete, file complete.

Base10: 3
Description: Hash tree incomplete, file incomplete.

Note:
SUBSCRIBE_HASH_TREE_CHANGES and SUBSCRIBE_FILE_CHANGES can be used to get bit
fields for exactly what blocks the host has, and to be updated when it gets new
blocks.
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: SUBSCRIBE_HASH_TREE_CHANGES
Base10: 7
Description: Request BIT_FIELD representing what hash tree blocks the host has.

+---+---+
| C | S |
+---+---+
  0   1

C = command, S = slot ID

Possible Responses:
BIT_FIELD
BIT_FIELD_COMPLETE
FILE_REMOVED
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: SUBSCRIBE_FILE_CHANGES
Base10: 8
Description: Request BIT_FIELD representing what file blocks the host has.

+---+---+
| C | S |
+---+---+
  0   1

C = command, S = slot ID

Possible Responses:
BIT_FIELD
BIT_FIELD_COMPLETE
FILE_REMOVED
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: BIT_FIELD
Base10: 9
Description: Bit field that represents what blocks the host has. This may be
hash tree or file blocks depending on if this message is in response to
SUBSCRIBE_HASH_TREE_CHANGES or SUBSCRIBE_FILE_CHANGES. The bit field is big
endian so byte 1 will contain the highest number blocks. A 0 bit represents a
block that the host has, a 1 bit represents a block that the host needs.

+---+---+---+---+---+
| C |       B       |
+---+---+---+---+---+
  0   1    ...    n

C = command, B = bit field

Note: The file size must be known to calculate how long the bit field will be.
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: BIT_FIELD_COMPLETE
Base10: 9
Description: Sent in response to SUBSCRIBE_HASH_TREE_CHANGES when hash tree
complete. Sent in response to SUBSCRIBE_FILE_CHANGES when file complete.

+---+
| C |
+---+
  0

C = command
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: BLOCK
Base10: 10
Description: Either a hash tree block or file block. The hash tree blocks vary
in size. The file blocks are fixed size except the last block which will be
shorter.

+---+---+---+---+---+---+---+---+
| C |             B             |
+---+---+---+---+---+---+---+---+
  0   1   2   3      ...    10240

C = command, B = block (maximum size of 10240)

Note: The block size will be highly variable for hash tree blocks because they
do not span two rows in a tree. All file blocks will be 10240 bytes except for
the last block.
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: HAVE_HASH_TREE_BLOCK
Base10: 11
Description: Sent to inform a host that a new hash tree block is available. This
is sent to all hosts that have a open slot for a file.

+---+---+---+---+---+---+
| C | S |       B       |
+---+---+---+---+---+---+
  0   1   2    ...    n

C = command, B = block number (VLI)
</pre>
</fieldset>

<br>

<fieldset>
<pre>
Name: HAVE_FILE_BLOCK
Base10: 12
Description: Sent to inform a host that a new file block is available. This is
sent to all hosts that have a open slot for a file.

+---+---+---+---+---+---+
| C | S |       B       |
+---+---+---+---+---+---+
  0   1   2    ...    n

C = command, B = block number (VLI)
</pre>
</fieldset>
</blockquote>

<br>

<b>2.4 Kademlia</b>
<blockquote>

</blockquote>

<br>

<b>2.5 Pipelining</b>
<blockquote>
<p>
Pipelining is done by sending multiple requests, and a new request whenever a
response is received. This increases throughput because the sender will never be
idle waiting for a request.
</p>
<p>
The maximum allowed pipeline size is 16. This would saturate a link with a
delay throughput product of less than 163840 (10240 * 16) bytes. For example, a
6Mb/s connection would have to have a latency greater than 213ms to not
saturate. This number is highly arbitrary and factors in buffering size, and

</p>
<b>Adaptive Pipeline Sizing Algorithm:</b>
<p>
This simple algorithm reduces the size of the pipeline to the minimum needed
without reducing throughput.
</p>
<pre>
Run after request fulfilled to adjust pipeline size.

C = current requests unfulfilled (requests in pipeline)
M = maximum pipeline size (this is what we adjust)
A = absolute maximum pipeline size (M always < A)

case: C == 0 && M < A
	//pipeline is too small, increase by one
	++M
case: C == 1
	//pipeline size optimal, do nothing
case: C > 1 && M > 1
	//pipeline is too large, decrease by one
	--M;
</pre>
</blockquote>

<b>2.6 Hash Tree</b>
<blockquote>

<p>
Merkle Hash Trees are used to distribute downloading of hash data needed to
verify the integrity of file blocks. The hash function used to generate the
tree is SHA1.
</p>

<p>
The bottom row of the tree consists of hashes for every 10240 bytes of the file
(however the last block may be shorter). Every row above the bottom row consists
of hashes for blocks of 512 hashes (may be less if there isn't 512 hashes left
in the child row).
</p>

<p>
The hash on the top of the tree is the root hash. The file size (8 byte
big-endian) with the root hash appended are then hashed together to get the hash
the file is tracked by.
</p>
</blockquote>

<b>2.7 Limits</b>
<blockquote>
The maximum file size is 2^64 bytes.

Hash trees are currently stored in SQLite. SQLite blobs are limited to
2^31 - 1 bytes. Files which would generate hash trees larger than this won't be
hashed until this limitation can be addressed.
</blockquote>

<b>3.0 Building</b>
<blockquote>
</blockquote>

<b>3.1 GNU/Linux</b>
<blockquote>
<p>
There are many different GNU/Linux distributions. Most likely you can use your
package manager to install the developer versions of these packages: boost, and
gtkmm.
</p>
</blockquote>

<b>3.2 Windows</b>
<blockquote>
<p>
<a href="http://www.microsoft.com/express/vc/">Visual C++ Express 2008</a><br>
The command line compiler will be used by scons. It is not necessary to register
to use the command line compiler.
</p>

<p>
<a href="http://www.boostpro.com/download">Boost</a><br>
Select Visual Studio 2008 and multithread static. Install the following libraries
(the VC9 versions): Date Time, Filesystem, Regex, System, Thread.
</p>

<p>
<a href="http://ftp.gnome.org/pub/GNOME/binaries/win32/gtkmm/">gtkmm</a> &#62;= 2.16.0-4<br>
Install to "C:\gtkmm" or pkg-config won't work properly.
</p>

<p>
<a href="http://python.org/download/">Python</a> &#62;= 1.5<br>
This is used to run the build system (SCons).
</p>

<p>
After installing the dependencies open cmd.exe, navigate to the source directory
and run "scons".
</p>
</blockquote>

</tr></td>
</table>

</body>
</html>
